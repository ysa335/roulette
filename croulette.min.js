const kFULL_TURN_DEG=360,kTWO_PI=Math.PI*2;
class Croulette{constructor(a,b={}){this.canvas=document.getElementById(a);this.ctx=this.canvas.getContext("2d");this.maxSegment=Math.max(1,b.segmentCount??10);this.evenColor=b.evenColor??"#ff0000";this.oddColor=b.oddColor??"#000000";this.offset=b.offset??20;this.speed=b.speed??10;this.debug=!!b.debug;this.segmentDegree=kFULL_TURN_DEG/this.maxSegment;this.segmentCenter=this.segmentDegree/2;this.angleR=this._toRadian(270-this.segmentCenter);this.targetRotation=this.angleInDegrees=this.angle=0;this.spining=
this.animating=!1;this.onSpining=this.onFinish=null;this.arrowColor=b.arrowColor??"#00ff00";this.digitColor=b.digitColor??"white";this.digitColor2=b.digitColor2??"white";this.debug=!1}drawPointer(){const a=this.ctx;let b=this.canvas.width/2-10,c=this.canvas.width/2+10;a.beginPath();a.moveTo(b,5);a.lineTo(c,5);a.lineTo(this.canvas.width/2,18);a.closePath();a.fillStyle=this.arrowColor;a.fill()}draw(){const a=this.ctx,b=this.canvas.width/2-this.offset;a.clearRect(0,this.offset,this.canvas.width,this.canvas.height);
a.save();a.translate(b+this.offset,b+this.offset*1.2);a.rotate(this.angleR);for(let c=0;c<this.maxSegment;c++){const e=kTWO_PI/this.maxSegment*c;a.beginPath();a.moveTo(0,0);a.fillStyle=c%2===0?this.evenColor:this.oddColor;a.arc(0,0,b,e,e+kTWO_PI/this.maxSegment);a.fill();a.stroke();a.save();a.rotate(e+Math.PI/this.maxSegment);a.translate(b-this.offset,0);a.rotate(-this.angleR-e-Math.PI/this.maxSegment);a.fillStyle=this.digitColor;a.font="24px sans-serif";a.textAlign="center";a.textBaseline="middle";
a.fillText(c+1,0,0);a.strokeStyle=this.digitColor2;a.strokeText(c+1,0,0);a.restore()}a.restore()}reset(){this.debug&&console.log("enter reest");this.animating=!1;this.angleR=this._toRadian(270-this.segmentCenter);this.targetRotation=0;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.draw();this.drawPointer()}rotateToNumber(a,b=2){this.debug&&console.log("enter rotateToNumber 1 / spining:"+this.spining);this.spining||(this.spining=!0);a<1?$("#message").text("\u6307\u5b9a\u3057\u305f\u30eb\u30fc\u30ec\u30c3\u30c8\u306e\u756a\u53f7\u304c\u30de\u30a4\u30ca\u30b9\u3067\u3059\u3002\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3059\u3002"):
this.maxSegment<a?$("#message").text("\u6307\u5b9a\u3057\u305f\u30eb\u30fc\u30ec\u30c3\u30c8\u306e\u756a\u53f7\u304c\u5206\u5272\u3055\u308c\u3066\u3044\u308b\u30b9\u30e9\u30a4\u30b9\u6570\u3092\u8d85\u3048\u3066\u3044\u307e\u3059\u3002\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3059\u3002"):this._rotateByDegree(kFULL_TURN_DEG*b+(this.maxSegment-a+1)%this.maxSegment*this.segmentDegree)}startSpin(){this.reset();this.spining=!0;this.rotateToNumber(this.maxSegment,100)}stopSpin(){this.debug&&console.log("enter stop angleInDegrees:"+
this.angleInDegrees);let a=this._getCurrentInfo().number;this.debug&&console.log("Stop Number:"+a);this.animating=this.spining=!1;if(typeof this.onFinish==="function")this.onFinish(a)}setOnFinish(a){this.onFinish=a}setOnSpining(a){this.onSpining=a}_getCurrentInfo(){let a=Math.trunc((kFULL_TURN_DEG-(this.angleInDegrees-this.segmentCenter))/this.segmentDegree+1)%this.maxSegment;a===0&&(a=this.maxSegment);return{number:a,angle:this.angleInDegrees}}_rotateByDegree(a=kFULL_TURN_DEG){if(!this.animating){this.debug&&
console.log("enter _rotateByDegree");this.targetRotation=a;this.animating=!0;var b=0,c=this.speed,e=()=>{if(this.spining)if(b<=this.targetRotation-c){b+=c;this.angleInDegrees=b%kFULL_TURN_DEG;c-=1E-4;this.angleR+=this._toRadian(c);this.angle=c;this.debug&&console.log("rotateByDigree angle:"+this.angle+" degree:"+this.angleInDegrees+" spining:"+this.spining);c<1&&(c=1,b=this.targetRotation);this.debug&&console.log("cspeed:"+c+" targetRotation:"+this.targetRotation+" angleInDegrees:"+b);var d=this.targetRotation-
b;d<c&&(this.angleR+=this._toRadian(d),this.angleInDegrees=(this.angleInDegrees+d)%kFULL_TURN_DEG,b=this.targetRotation);this.draw();requestAnimationFrame(e);typeof this.onSpining==="function"&&(d=this._getCurrentInfo(),this.onSpining(d))}else c=0,b=this.targetRotation,d=kFULL_TURN_DEG/this.maxSegment,d=(Math.floor((kFULL_TURN_DEG-this.targetRotation%kFULL_TURN_DEG+d/2)%kFULL_TURN_DEG/d)+this.maxSegment)%this.maxSegment+1,this.drawPointer(),typeof this.onFinish==="function"&&(this.animating=!1,this.onFinish(d))};
e()}}_toRadian(a){return a*Math.PI/180}};
